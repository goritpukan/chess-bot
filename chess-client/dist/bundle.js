(()=>{function No(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function Do(e,t,r,n,o){let i={move:e,variations:o};return t&&(i.suffix=t),r&&(i.nag=r),n!==null&&(i.comment=n),i}function Oo(...e){let[t,...r]=e,n=t;for(let o of r)o!==null&&(n.variations=[o,...o.variations],o.variations=[],n=o);return t}function Ko(e,t){if(t.marker&&t.marker.comment){let r=t.root;for(;;){let n=r.variations[0];if(!n){r.comment=t.marker.comment;break}r=n}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function Io(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function Ae(e,t,r,n){var o=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(o,Ae.prototype),o.expected=t,o.found=r,o.location=n,o.name="SyntaxError",o}Io(Ae,Error);function bt(e,t,r){return r=r||" ",e.length>t?e:(t-=e.length,r+=r.repeat(t),e+r.slice(0,t))}Ae.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var r=null,n;for(n=0;n<e.length;n++)if(e[n].source===this.location.source){r=e[n].text.split(/\r\n|\n|\r/g);break}var o=this.location.start,i=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(o):o,s=this.location.source+":"+i.line+":"+i.column;if(r){var a=this.location.end,f=bt("",i.line.toString().length," "),l=r[o.line-1],u=o.line===a.line?a.column:l.length+1,m=u-o.column||1;t+=`
 --> `+s+`
`+f+` |
`+i.line+" | "+l+`
`+f+" | "+bt("",o.column-1," ")+bt("",m,"^")}else t+=`
 at `+s}return t};Ae.buildMessage=function(e,t){var r={literal:function(l){return'"'+o(l.text)+'"'},class:function(l){var u=l.parts.map(function(m){return Array.isArray(m)?i(m[0])+"-"+i(m[1]):i(m)});return"["+(l.inverted?"^":"")+u.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(l){return l.description}};function n(l){return l.charCodeAt(0).toString(16).toUpperCase()}function o(l){return l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+n(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+n(u)})}function i(l){return l.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+n(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+n(u)})}function s(l){return r[l.type](l)}function a(l){var u=l.map(s),m,g;if(u.sort(),u.length>0){for(m=1,g=1;m<u.length;m++)u[m-1]!==u[m]&&(u[g]=u[m],g++);u.length=g}switch(u.length){case 1:return u[0];case 2:return u[0]+" or "+u[1];default:return u.slice(0,-1).join(", ")+", or "+u[u.length-1]}}function f(l){return l?'"'+o(l)+'"':"end of input"}return"Expected "+a(e)+" but "+f(t)+" found."};function Ro(e,t){t=t!==void 0?t:{};var r={},n=t.grammarSource,o={pgn:hr},i=hr,s="[",a='"',f="]",l=".",u="O-O-O",m="O-O",g="0-0-0",b="0-0",P="$",_="{",q="}",re=";",F="(",de=")",ke="1-0",j="0-1",Pe="1/2-1/2",Ce="*",M=/^[a-zA-Z]/,le=/^[^"]/,B=/^[0-9]/,Q=/^[.]/,ge=/^[a-zA-Z1-8\-=]/,qn=/^[+#]/,Xt=/^[!?]/,Jt=/^[^}]/,er=/^[^\r\n]/,tr=/^[ \t\r\n]/,Nn=z("tag pair"),Dn=D("[",!1),rr=D('"',!1),On=D("]",!1),Kn=z("tag name"),gt=ne([["a","z"],["A","Z"]],!1,!1),In=z("tag value"),nr=ne(['"'],!0,!1),Rn=z("move number"),je=ne([["0","9"]],!1,!1),Ln=D(".",!1),or=ne(["."],!1,!1),Fn=z("standard algebraic notation"),Bn=D("O-O-O",!1),Un=D("O-O",!1),Hn=D("0-0-0",!1),Wn=D("0-0",!1),ir=ne([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),jn=ne(["+","#"],!1,!1),Qn=z("suffix annotation"),sr=ne(["!","?"],!1,!1),Vn=z("NAG"),zn=D("$",!1),Gn=z("brace comment"),Zn=D("{",!1),ar=ne(["}"],!0,!1),Yn=D("}",!1),Xn=z("rest of line comment"),Jn=D(";",!1),lr=ne(["\r",`
`],!0,!1),eo=z("variation"),to=D("(",!1),ro=D(")",!1),no=z("game termination marker"),oo=D("1-0",!1),io=D("0-1",!1),so=D("1/2-1/2",!1),ao=D("*",!1),lo=z("whitespace"),cr=ne([" ","	","\r",`
`],!1,!1),co=function(c,p){return Ko(c,p)},fo=function(c){return Object.fromEntries(c)},uo=function(c,p){return[c,p]},ho=function(c,p){return{root:c,marker:p}},po=function(c,p){return Oo(No(c),...p.flat())},go=function(c,p,d,y,k){return Do(c,p,d,y,k)},mo=function(c){return c},bo=function(c){return c.replace(/[\r\n]+/g," ")},vo=function(c){return c.trim()},_o=function(c){return c},wo=function(c,p){return{result:c,comment:p}},h=t.peg$currPos|0,Se=[{line:1,column:1}],Y=h,Qe=t.peg$maxFailExpected||[],v=t.peg$silentFails|0,qe;if(t.startRule){if(!(t.startRule in o))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=o[t.startRule]}function D(c,p){return{type:"literal",text:c,ignoreCase:p}}function ne(c,p,d){return{type:"class",parts:c,inverted:p,ignoreCase:d}}function yo(){return{type:"end"}}function z(c){return{type:"other",description:c}}function fr(c){var p=Se[c],d;if(p)return p;if(c>=Se.length)d=Se.length-1;else for(d=c;!Se[--d];);for(p=Se[d],p={line:p.line,column:p.column};d<c;)e.charCodeAt(d)===10?(p.line++,p.column=1):p.column++,d++;return Se[c]=p,p}function ur(c,p,d){var y=fr(c),k=fr(p),A={source:n,start:{offset:c,line:y.line,column:y.column},end:{offset:p,line:k.line,column:k.column}};return A}function w(c){h<Y||(h>Y&&(Y=h,Qe=[]),Qe.push(c))}function ko(c,p,d){return new Ae(Ae.buildMessage(c,p),c,p,d)}function hr(){var c,p,d;return c=h,p=Po(),d=Eo(),c=co(p,d),c}function Po(){var c,p,d;for(c=h,p=[],d=pr();d!==r;)p.push(d),d=pr();return d=U(),c=fo(p),c}function pr(){var c,p,d,y,k,A,me;return v++,c=h,U(),e.charCodeAt(h)===91?(p=s,h++):(p=r,v===0&&w(Dn)),p!==r?(U(),d=Co(),d!==r?(U(),e.charCodeAt(h)===34?(y=a,h++):(y=r,v===0&&w(rr)),y!==r?(k=So(),e.charCodeAt(h)===34?(A=a,h++):(A=r,v===0&&w(rr)),A!==r?(U(),e.charCodeAt(h)===93?(me=f,h++):(me=r,v===0&&w(On)),me!==r?c=uo(d,k):(h=c,c=r)):(h=c,c=r)):(h=c,c=r)):(h=c,c=r)):(h=c,c=r),v--,c===r&&v===0&&w(Nn),c}function Co(){var c,p,d;if(v++,c=h,p=[],d=e.charAt(h),M.test(d)?h++:(d=r,v===0&&w(gt)),d!==r)for(;d!==r;)p.push(d),d=e.charAt(h),M.test(d)?h++:(d=r,v===0&&w(gt));else p=r;return p!==r?c=e.substring(c,h):c=p,v--,c===r&&(p=r,v===0&&w(Kn)),c}function So(){var c,p,d;for(v++,c=h,p=[],d=e.charAt(h),le.test(d)?h++:(d=r,v===0&&w(nr));d!==r;)p.push(d),d=e.charAt(h),le.test(d)?h++:(d=r,v===0&&w(nr));return c=e.substring(c,h),v--,p=r,v===0&&w(In),c}function Eo(){var c,p,d;return c=h,p=dr(),U(),d=qo(),d===r&&(d=null),U(),c=ho(p,d),c}function dr(){var c,p,d,y;for(c=h,p=mt(),p===r&&(p=null),d=[],y=gr();y!==r;)d.push(y),y=gr();return c=po(p,d),c}function gr(){var c,p,d,y,k,A,me,Ve;if(c=h,U(),Ao(),U(),p=Mo(),p!==r){for(d=$o(),d===r&&(d=null),y=[],k=mr();k!==r;)y.push(k),k=mr();for(k=U(),A=mt(),A===r&&(A=null),me=[],Ve=br();Ve!==r;)me.push(Ve),Ve=br();c=go(p,d,y,A,me)}else h=c,c=r;return c}function Ao(){var c,p,d,y,k,A;for(v++,c=h,p=[],d=e.charAt(h),B.test(d)?h++:(d=r,v===0&&w(je));d!==r;)p.push(d),d=e.charAt(h),B.test(d)?h++:(d=r,v===0&&w(je));if(e.charCodeAt(h)===46?(d=l,h++):(d=r,v===0&&w(Ln)),d!==r){for(y=U(),k=[],A=e.charAt(h),Q.test(A)?h++:(A=r,v===0&&w(or));A!==r;)k.push(A),A=e.charAt(h),Q.test(A)?h++:(A=r,v===0&&w(or));p=[p,d,y,k],c=p}else h=c,c=r;return v--,c===r&&(p=r,v===0&&w(Rn)),c}function Mo(){var c,p,d,y,k,A;if(v++,c=h,p=h,e.substr(h,5)===u?(d=u,h+=5):(d=r,v===0&&w(Bn)),d===r&&(e.substr(h,3)===m?(d=m,h+=3):(d=r,v===0&&w(Un)),d===r&&(e.substr(h,5)===g?(d=g,h+=5):(d=r,v===0&&w(Hn)),d===r&&(e.substr(h,3)===b?(d=b,h+=3):(d=r,v===0&&w(Wn)),d===r))))if(d=h,y=e.charAt(h),M.test(y)?h++:(y=r,v===0&&w(gt)),y!==r){if(k=[],A=e.charAt(h),ge.test(A)?h++:(A=r,v===0&&w(ir)),A!==r)for(;A!==r;)k.push(A),A=e.charAt(h),ge.test(A)?h++:(A=r,v===0&&w(ir));else k=r;k!==r?(y=[y,k],d=y):(h=d,d=r)}else h=d,d=r;return d!==r?(y=e.charAt(h),qn.test(y)?h++:(y=r,v===0&&w(jn)),y===r&&(y=null),d=[d,y],p=d):(h=p,p=r),p!==r?c=e.substring(c,h):c=p,v--,c===r&&(p=r,v===0&&w(Fn)),c}function $o(){var c,p,d;for(v++,c=h,p=[],d=e.charAt(h),Xt.test(d)?h++:(d=r,v===0&&w(sr));d!==r;)p.push(d),p.length>=2?d=r:(d=e.charAt(h),Xt.test(d)?h++:(d=r,v===0&&w(sr)));return p.length<1?(h=c,c=r):c=p,v--,c===r&&(p=r,v===0&&w(Qn)),c}function mr(){var c,p,d,y,k;if(v++,c=h,U(),e.charCodeAt(h)===36?(p=P,h++):(p=r,v===0&&w(zn)),p!==r){if(d=h,y=[],k=e.charAt(h),B.test(k)?h++:(k=r,v===0&&w(je)),k!==r)for(;k!==r;)y.push(k),k=e.charAt(h),B.test(k)?h++:(k=r,v===0&&w(je));else y=r;y!==r?d=e.substring(d,h):d=y,d!==r?c=mo(d):(h=c,c=r)}else h=c,c=r;return v--,c===r&&v===0&&w(Vn),c}function mt(){var c;return c=To(),c===r&&(c=xo()),c}function To(){var c,p,d,y,k;if(v++,c=h,e.charCodeAt(h)===123?(p=_,h++):(p=r,v===0&&w(Zn)),p!==r){for(d=h,y=[],k=e.charAt(h),Jt.test(k)?h++:(k=r,v===0&&w(ar));k!==r;)y.push(k),k=e.charAt(h),Jt.test(k)?h++:(k=r,v===0&&w(ar));d=e.substring(d,h),e.charCodeAt(h)===125?(y=q,h++):(y=r,v===0&&w(Yn)),y!==r?c=bo(d):(h=c,c=r)}else h=c,c=r;return v--,c===r&&(p=r,v===0&&w(Gn)),c}function xo(){var c,p,d,y,k;if(v++,c=h,e.charCodeAt(h)===59?(p=re,h++):(p=r,v===0&&w(Jn)),p!==r){for(d=h,y=[],k=e.charAt(h),er.test(k)?h++:(k=r,v===0&&w(lr));k!==r;)y.push(k),k=e.charAt(h),er.test(k)?h++:(k=r,v===0&&w(lr));d=e.substring(d,h),c=vo(d)}else h=c,c=r;return v--,c===r&&(p=r,v===0&&w(Xn)),c}function br(){var c,p,d,y;return v++,c=h,U(),e.charCodeAt(h)===40?(p=F,h++):(p=r,v===0&&w(to)),p!==r?(d=dr(),d!==r?(U(),e.charCodeAt(h)===41?(y=de,h++):(y=r,v===0&&w(ro)),y!==r?c=_o(d):(h=c,c=r)):(h=c,c=r)):(h=c,c=r),v--,c===r&&v===0&&w(eo),c}function qo(){var c,p,d;return v++,c=h,e.substr(h,3)===ke?(p=ke,h+=3):(p=r,v===0&&w(oo)),p===r&&(e.substr(h,3)===j?(p=j,h+=3):(p=r,v===0&&w(io)),p===r&&(e.substr(h,7)===Pe?(p=Pe,h+=7):(p=r,v===0&&w(so)),p===r&&(e.charCodeAt(h)===42?(p=Ce,h++):(p=r,v===0&&w(ao))))),p!==r?(U(),d=mt(),d===r&&(d=null),c=wo(p,d)):(h=c,c=r),v--,c===r&&(p=r,v===0&&w(no)),c}function U(){var c,p;for(v++,c=[],p=e.charAt(h),tr.test(p)?h++:(p=r,v===0&&w(cr));p!==r;)c.push(p),p=e.charAt(h),tr.test(p)?h++:(p=r,v===0&&w(cr));return v--,p=r,v===0&&w(lo),c}if(qe=i(),t.peg$library)return{peg$result:qe,peg$currPos:h,peg$FAILED:r,peg$maxFailExpected:Qe,peg$maxFailPos:Y};if(qe!==r&&h===e.length)return qe;throw qe!==r&&h<e.length&&w(yo()),ko(Qe,Y<e.length?e.charAt(Y):null,Y<e.length?ur(Y,Y+1):ur(Y,Y))}var Ge=0xffffffffffffffffn;function vt(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function vr(e,t){return e*t&Ge}function Lo(e){return function(){let t=BigInt(e&Ge),r=BigInt(e>>64n&Ge),n=vr(vt(vr(t,5n),7n),9n);return r^=t,t=(vt(t,24n)^r^r<<16n)&Ge,r=vt(r,37n),e=r<<64n|t,n}}var Xe=Lo(0xa187eb39cdcaed8f31c4b365b102e01en),Fo=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Xe()))),Bo=Array.from({length:8},()=>Xe()),Uo=Array.from({length:16},()=>Xe()),_t=Xe(),R="w",V="b",T="p",Ct="n",Ze="b",De="r",ue="q",N="k",wt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",Ee=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,r){let{color:n,piece:o,from:i,to:s,flags:a,captured:f,promotion:l}=r,u=O(i),m=O(s);this.color=n,this.piece=o,this.from=u,this.to=m,this.san=t._moveToSan(r,t._moves({legal:!0})),this.lan=u+m,this.before=t.fen(),t._makeMove(r),this.after=t.fen(),t._undoMove(),this.flags="";for(let g in S)S[g]&a&&(this.flags+=be[g]);f&&(this.captured=f),l&&(this.promotion=l,this.lan+=l)}isCapture(){return this.flags.indexOf(be.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(be.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(be.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(be.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(be.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(be.BIG_PAWN)>-1}},I=-1,be={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var S={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},St={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ho={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Wo={...St,...Ho},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},yt={b:[16,32,17,15],w:[-16,-32,-17,-15]},_r={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},jo=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Qo=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Vo={p:1,n:2,b:4,r:8,q:16,k:32},zo="pnbrqkPNBRQK",wr=[Ct,Ze,De,ue],Go=7,Zo=6,Yo=1,Xo=0,ze={[N]:S.KSIDE_CASTLE,[ue]:S.QSIDE_CASTLE},ce={w:[{square:C.a1,flag:S.QSIDE_CASTLE},{square:C.h1,flag:S.KSIDE_CASTLE}],b:[{square:C.a8,flag:S.QSIDE_CASTLE},{square:C.h8,flag:S.KSIDE_CASTLE}]},Jo={b:Yo,w:Zo},kt="--";function ve(e){return e>>4}function Oe(e){return e&15}function kr(e){return"0123456789".indexOf(e)!==-1}function O(e){let t=Oe(e),r=ve(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(r,r+1)}function Ne(e){return e===R?V:R}function ei(e){let t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let r=parseInt(t[5],10);if(isNaN(r)||r<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let n=parseInt(t[4],10);if(isNaN(n)||n<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let o=t[0].split("/");if(o.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<o.length;s++){let a=0,f=!1;for(let l=0;l<o[s].length;l++)if(kr(o[s][l])){if(f)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(o[s][l],10),f=!0}else{if(!/^[prnbqkPRNBQK]$/.test(o[s][l]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,f=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:s,regex:a}of i){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(o[0]+o[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function ti(e,t){let r=e.from,n=e.to,o=e.piece,i=0,s=0,a=0;for(let f=0,l=t.length;f<l;f++){let u=t[f].from,m=t[f].to,g=t[f].piece;o===g&&r!==u&&n===m&&(i++,ve(r)===ve(u)&&s++,Oe(r)===Oe(u)&&a++)}return i>0?s>0&&a>0?O(r):a>0?O(r).charAt(1):O(r).charAt(0):""}function fe(e,t,r,n,o,i=void 0,s=S.NORMAL){let a=ve(n);if(o===T&&(a===Go||a===Xo))for(let f=0;f<wr.length;f++){let l=wr[f];e.push({color:t,from:r,to:n,piece:o,captured:i,promotion:l,flags:s|S.PROMOTION})}else e.push({color:t,from:r,to:n,piece:o,captured:i,flags:s})}function yr(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(t=t.toLowerCase(),t==="o"?N:t)}function Pt(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var Ye=class{_board=new Array(128);_turn=R;_header={};_kings={w:I,b:I};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=wt,{skipValidation:r=!1}={}){this.load(t,{skipValidation:r})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:I,b:I},this._turn=R,this._castling={w:0,b:0},this._epSquare=I,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Wo},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:r=!1,preserveHeaders:n=!1}={}){let o=t.split(/\s+/);if(o.length>=2&&o.length<6){let a=["-","-","0","1"];t=o.concat(a.slice(-(6-o.length))).join(" ")}if(o=t.split(/\s+/),!r){let{ok:a,error:f}=ei(t);if(!a)throw new Error(f)}let i=o[0],s=0;this.clear({preserveHeaders:n});for(let a=0;a<i.length;a++){let f=i.charAt(a);if(f==="/")s+=8;else if(kr(f))s+=parseInt(f,10);else{let l=f<"a"?R:V;this._put({type:f.toLowerCase(),color:l},O(s)),s++}}this._turn=o[1],o[2].indexOf("K")>-1&&(this._castling.w|=S.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(this._castling.w|=S.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(this._castling.b|=S.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(this._castling.b|=S.QSIDE_CASTLE),this._epSquare=o[3]==="-"?I:C[o[3]],this._halfMoves=parseInt(o[4],10),this._moveNumber=parseInt(o[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let r=0,n="";for(let s=C.a8;s<=C.h1;s++){if(this._board[s]){r>0&&(n+=r,r=0);let{color:a,type:f}=this._board[s];n+=a===R?f.toUpperCase():f.toLowerCase()}else r++;s+1&136&&(r>0&&(n+=r),s!==C.h1&&(n+="/"),r=0,s+=8)}let o="";this._castling[R]&S.KSIDE_CASTLE&&(o+="K"),this._castling[R]&S.QSIDE_CASTLE&&(o+="Q"),this._castling[V]&S.KSIDE_CASTLE&&(o+="k"),this._castling[V]&S.QSIDE_CASTLE&&(o+="q"),o=o||"-";let i="-";if(this._epSquare!==I)if(t)i=O(this._epSquare);else{let s=this._epSquare+(this._turn===R?16:-16),a=[s+1,s-1];for(let f of a){if(f&136)continue;let l=this._turn;if(this._board[f]?.color===l&&this._board[f]?.type===T){this._makeMove({color:l,from:f,to:this._epSquare,piece:T,captured:T,flags:S.EP_CAPTURE});let u=!this._isKingAttacked(l);if(this._undoMove(),u){i=O(this._epSquare);break}}}}return[n,this._turn,o,i,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:r,type:n}=this._board[t],o={w:0,b:1}[r],i={p:0,n:1,b:2,r:3,q:4,k:5}[n];return Fo[o][i][t]}_epKey(){return this._epSquare===I?0n:Bo[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return Uo[t]}_computeHash(){let t=0n;for(let r=C.a8;r<=C.h1;r++){if(r&136){r+=7;continue}this._board[r]&&(t^=this._pieceKey(r))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=_t),t}_updateSetup(t){this._history.length>0||(t!==wt?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(wt)}get(t){return this._board[C[t]]}findPiece(t){let r=[];for(let n=C.a8;n<=C.h1;n++){if(n&136){n+=7;continue}!this._board[n]||this._board[n]?.color!==t.color||this._board[n].color===t.color&&this._board[n].type===t.type&&r.push(O(n))}return r}put({type:t,color:r},n){return this._put({type:t,color:r},n)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,r){this._hash^=this._pieceKey(t),this._board[t]=r,this._hash^=this._pieceKey(t)}_put({type:t,color:r},n){if(zo.indexOf(t.toLowerCase())===-1||!(n in C))return!1;let o=C[n];if(t==N&&!(this._kings[r]==I||this._kings[r]==o))return!1;let i=this._board[o];return i&&i.type===N&&(this._kings[i.color]=I),this._set(o,{type:t,color:r}),t===N&&(this._kings[r]=o),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let r=this.get(t);return this._clear(C[t]),r&&r.type===N&&(this._kings[r.color]=I),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),r}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[C.e1]?.type===N&&this._board[C.e1]?.color===R,r=this._board[C.e8]?.type===N&&this._board[C.e8]?.color===V;(!t||this._board[C.a1]?.type!==De||this._board[C.a1]?.color!==R)&&(this._castling.w&=-65),(!t||this._board[C.h1]?.type!==De||this._board[C.h1]?.color!==R)&&(this._castling.w&=-33),(!r||this._board[C.a8]?.type!==De||this._board[C.a8]?.color!==V)&&(this._castling.b&=-65),(!r||this._board[C.h8]?.type!==De||this._board[C.h8]?.color!==V)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===I)return;let t=this._epSquare+(this._turn===R?-16:16),r=this._epSquare+(this._turn===R?16:-16),n=[r+1,r-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[r]?.color!==Ne(this._turn)||this._board[r]?.type!==T){this._hash^=this._epKey(),this._epSquare=I;return}let o=i=>!(i&136)&&this._board[i]?.color===this._turn&&this._board[i]?.type===T;n.some(o)||(this._hash^=this._epKey(),this._epSquare=I)}_attacked(t,r,n){let o=[];for(let i=C.a8;i<=C.h1;i++){if(i&136){i+=7;continue}if(this._board[i]===void 0||this._board[i].color!==t)continue;let s=this._board[i],a=i-r;if(a===0)continue;let f=a+119;if(jo[f]&Vo[s.type]){if(s.type===T){if(a>0&&s.color===R||a<=0&&s.color===V)if(n)o.push(O(i));else return!0;continue}if(s.type==="n"||s.type==="k")if(n){o.push(O(i));continue}else return!0;let l=Qo[f],u=i+l,m=!1;for(;u!==r;){if(this._board[u]!=null){m=!0;break}u+=l}if(!m)if(n){o.push(O(i));continue}else return!0}}return n?o:!1}attackers(t,r){return r?this._attacked(r,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){let r=this._kings[t];return r===-1?!1:this._attacked(Ne(t),r)}hash(){return this._hash.toString(16)}isAttacked(t,r){return this._attacked(r,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},r=[],n=0,o=0;for(let i=C.a8;i<=C.h1;i++){if(o=(o+1)%2,i&136){i+=7;continue}let s=this._board[i];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===Ze&&r.push(o),n++)}if(n===2)return!0;if(n===3&&(t[Ze]===1||t[Ct]===1))return!0;if(n===t[Ze]+2){let i=0,s=r.length;for(let a=0;a<s;a++)i+=r[a];if(i===0||i===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:r=void 0,piece:n=void 0}={}){let o=this._moves({square:r,piece:n});return t?o.map(i=>new Ee(this,i)):o.map(i=>this._moveToSan(i,o))}_moves({legal:t=!0,piece:r=void 0,square:n=void 0}={}){let o=n?n.toLowerCase():void 0,i=r?.toLowerCase(),s=[],a=this._turn,f=Ne(a),l=C.a8,u=C.h1,m=!1;if(o)if(o in C)l=u=C[o],m=!0;else return[];for(let b=l;b<=u;b++){if(b&136){b+=7;continue}if(!this._board[b]||this._board[b].color===f)continue;let{type:P}=this._board[b],_;if(P===T){if(i&&i!==P)continue;_=b+yt[a][0],this._board[_]||(fe(s,a,b,_,T),_=b+yt[a][1],Jo[a]===ve(b)&&!this._board[_]&&fe(s,a,b,_,T,void 0,S.BIG_PAWN));for(let q=2;q<4;q++)_=b+yt[a][q],!(_&136)&&(this._board[_]?.color===f?fe(s,a,b,_,T,this._board[_].type,S.CAPTURE):_===this._epSquare&&fe(s,a,b,_,T,T,S.EP_CAPTURE))}else{if(i&&i!==P)continue;for(let q=0,re=_r[P].length;q<re;q++){let F=_r[P][q];for(_=b;_+=F,!(_&136);){if(!this._board[_])fe(s,a,b,_,P);else{if(this._board[_].color===a)break;fe(s,a,b,_,P,this._board[_].type,S.CAPTURE);break}if(P===Ct||P===N)break}}}}if((i===void 0||i===N)&&(!m||u===this._kings[a])){if(this._castling[a]&S.KSIDE_CASTLE){let b=this._kings[a],P=b+2;!this._board[b+1]&&!this._board[P]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,b+1)&&!this._attacked(f,P)&&fe(s,a,this._kings[a],P,N,void 0,S.KSIDE_CASTLE)}if(this._castling[a]&S.QSIDE_CASTLE){let b=this._kings[a],P=b-2;!this._board[b-1]&&!this._board[b-2]&&!this._board[b-3]&&!this._attacked(f,this._kings[a])&&!this._attacked(f,b-1)&&!this._attacked(f,P)&&fe(s,a,this._kings[a],P,N,void 0,S.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;let g=[];for(let b=0,P=s.length;b<P;b++)this._makeMove(s[b]),this._isKingAttacked(a)||g.push(s[b]),this._undoMove();return g}move(t,{strict:r=!1}={}){let n=null;if(typeof t=="string")n=this._moveFromSan(t,r);else if(t===null)n=this._moveFromSan(kt,r);else if(typeof t=="object"){let i=this._moves();for(let s=0,a=i.length;s<a;s++)if(t.from===O(i[s].from)&&t.to===O(i[s].to)&&(!("promotion"in i[s])||t.promotion===i[s].promotion)){n=i[s];break}}if(!n)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&n.flags&S.NULL_MOVE)throw new Error("Null move not allowed when in check");let o=new Ee(this,n);return this._makeMove(n),this._incPositionCount(),o}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,r){this._hash^=this._pieceKey(t),this._board[r]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(r)}_makeMove(t){let r=this._turn,n=Ne(r);if(this._push(t),t.flags&S.NULL_MOVE){r===V&&this._moveNumber++,this._halfMoves++,this._turn=n,this._epSquare=I;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&S.EP_CAPTURE&&(this._turn===V?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:r})),this._board[t.to].type===N){if(this._kings[r]=t.to,t.flags&S.KSIDE_CASTLE){let o=t.to-1,i=t.to+1;this._movePiece(i,o)}else if(t.flags&S.QSIDE_CASTLE){let o=t.to+1,i=t.to-2;this._movePiece(i,o)}this._castling[r]=0}if(this._castling[r]){for(let o=0,i=ce[r].length;o<i;o++)if(t.from===ce[r][o].square&&this._castling[r]&ce[r][o].flag){this._castling[r]^=ce[r][o].flag;break}}if(this._castling[n]){for(let o=0,i=ce[n].length;o<i;o++)if(t.to===ce[n][o].square&&this._castling[n]&ce[n][o].flag){this._castling[n]^=ce[n][o].flag;break}}if(this._hash^=this._castlingKey(),t.flags&S.BIG_PAWN){let o;r===V?o=t.to-16:o=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===T&&this._board[t.to-1]?.color===n||!(t.to+1&136)&&this._board[t.to+1]?.type===T&&this._board[t.to+1]?.color===n?(this._epSquare=o,this._hash^=this._epKey()):this._epSquare=I}else this._epSquare=I;t.piece===T?this._halfMoves=0:t.flags&(S.CAPTURE|S.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,r===V&&this._moveNumber++,this._turn=n,this._hash^=_t}undo(){let t=this._hash,r=this._undoMove();if(r){let n=new Ee(this,r);return this._decPositionCount(t),n}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let r=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=_t;let n=this._turn,o=Ne(n);if(r.flags&S.NULL_MOVE)return r;if(this._movePiece(r.to,r.from),r.piece&&(this._clear(r.from),this._set(r.from,{type:r.piece,color:n})),r.captured)if(r.flags&S.EP_CAPTURE){let i;n===V?i=r.to-16:i=r.to+16,this._set(i,{type:T,color:o})}else this._set(r.to,{type:r.captured,color:o});if(r.flags&(S.KSIDE_CASTLE|S.QSIDE_CASTLE)){let i,s;r.flags&S.KSIDE_CASTLE?(i=r.to+1,s=r.to-1):(i=r.to-2,s=r.to+1),this._movePiece(s,i)}return r}pgn({newline:t=`
`,maxWidth:r=0}={}){let n=[],o=!1;for(let g in this._header)this._header[g]&&n.push(`[${g} "${this._header[g]}"]`+t),o=!0;o&&this._history.length&&n.push(t);let i=g=>{let b=this._comments[this.fen()];if(typeof b<"u"){let P=g.length>0?" ":"";g=`${g}${P}{${b}}`}return g},s=[];for(;this._history.length>0;)s.push(this._undoMove());let a=[],f="";for(s.length===0&&a.push(i(""));s.length>0;){f=i(f);let g=s.pop();if(!g)break;if(!this._history.length&&g.color==="b"){let b=`${this._moveNumber}. ...`;f=f?`${f} ${b}`:b}else g.color==="w"&&(f.length&&a.push(f),f=this._moveNumber+".");f=f+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(f.length&&a.push(i(f)),a.push(this._header.Result||"*"),r===0)return n.join("")+a.join(" ");let l=function(){return n.length>0&&n[n.length-1]===" "?(n.pop(),!0):!1},u=function(g,b){for(let P of b.split(" "))if(P){if(g+P.length>r){for(;l();)g--;n.push(t),g=0}n.push(P),g+=P.length,n.push(" "),g++}return l()&&g--,g},m=0;for(let g=0;g<a.length;g++){if(m+a[g].length>r&&a[g].includes("{")){m=u(m,a[g]);continue}m+a[g].length>r&&g!==0?(n[n.length-1]===" "&&n.pop(),n.push(t),m=0):g!==0&&(n.push(" "),m++),n.push(a[g]),m+=a[g].length}return n.join("")}header(...t){for(let r=0;r<t.length;r+=2)typeof t[r]=="string"&&typeof t[r+1]=="string"&&(this._header[t[r]]=t[r+1]);return this._header}setHeader(t,r){return this._header[t]=r??St[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=St[t]||null,!0):!1}getHeaders(){let t={};for(let[r,n]of Object.entries(this._header))n!==null&&(t[r]=n);return t}loadPgn(t,{strict:r=!1,newlineChar:n=`\r?
`}={}){n!==`\r?
`&&(t=t.replace(new RegExp(n,"g"),`
`));let o=Ro(t);this.reset();let i=o.headers,s="";for(let l in i)l.toLowerCase()==="fen"&&(s=i[l]),this.header(l,i[l]);if(!r)s&&this.load(s,{preserveHeaders:!0});else if(i.SetUp==="1"){if(!("FEN"in i))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(i.FEN,{preserveHeaders:!0})}let a=o.root;for(;a;){if(a.move){let l=this._moveFromSan(a.move,r);if(l==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(l),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}let f=o.result;f&&Object.keys(this._header).length&&this._header.Result!==f&&this.setHeader("Result",f)}_moveToSan(t,r){let n="";if(t.flags&S.KSIDE_CASTLE)n="O-O";else if(t.flags&S.QSIDE_CASTLE)n="O-O-O";else{if(t.flags&S.NULL_MOVE)return kt;if(t.piece!==T){let o=ti(t,r);n+=t.piece.toUpperCase()+o}t.flags&(S.CAPTURE|S.EP_CAPTURE)&&(t.piece===T&&(n+=O(t.from)[0]),n+="x"),n+=O(t.to),t.promotion&&(n+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?n+="#":n+="+"),this._undoMove(),n}_moveFromSan(t,r=!1){let n=Pt(t);if(r||(n==="0-0"?n="O-O":n==="0-0-0"&&(n="O-O-O")),n==kt)return{color:this._turn,from:0,to:0,piece:"k",flags:S.NULL_MOVE};let o=yr(n),i=this._moves({legal:!0,piece:o});for(let g=0,b=i.length;g<b;g++)if(n===Pt(this._moveToSan(i[g],i)))return i[g];if(r)return null;let s,a,f,l,u,m=!1;if(a=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],f=a[2],l=a[3],u=a[4],f.length==1&&(m=!0)):(a=n.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],f=a[2],l=a[3],u=a[4],f.length==1&&(m=!0))),o=yr(n),i=this._moves({legal:!0,piece:s||o}),!l)return null;for(let g=0,b=i.length;g<b;g++)if(f){if((!s||s.toLowerCase()==i[g].piece)&&C[f]==i[g].from&&C[l]==i[g].to&&(!u||u.toLowerCase()==i[g].promotion))return i[g];if(m){let P=O(i[g].from);if((!s||s.toLowerCase()==i[g].piece)&&C[l]==i[g].to&&(f==P[0]||f==P[1])&&(!u||u.toLowerCase()==i[g].promotion))return i[g]}}else if(n===Pt(this._moveToSan(i[g],i)).replace("x",""))return i[g];return null}ascii(){let t=`   +------------------------+
`;for(let r=C.a8;r<=C.h1;r++){if(Oe(r)===0&&(t+=" "+"87654321"[ve(r)]+" |"),this._board[r]){let n=this._board[r].type,i=this._board[r].color===R?n.toUpperCase():n.toLowerCase();t+=" "+i+" "}else t+=" . ";r+1&136&&(t+=`|
`,r+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let r=this._moves({legal:!1}),n=0,o=this._turn;for(let i=0,s=r.length;i<s;i++)this._makeMove(r[i]),this._isKingAttacked(o)||(t-1>0?n+=this.perft(t-1):n++),this._undoMove();return n}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],r=[];for(let n=C.a8;n<=C.h1;n++)this._board[n]==null?r.push(null):r.push({square:O(n),type:this._board[n].type,color:this._board[n].color}),n+1&136&&(t.push(r),r=[],n+=8);return t}squareColor(t){if(t in C){let r=C[t];return(ve(r)+Oe(r))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let r=[],n=[];for(;this._history.length>0;)r.push(this._undoMove());for(;;){let o=r.pop();if(!o)break;t?n.push(new Ee(this,o)):n.push(this._moveToSan(o,this._moves())),this._makeMove(o)}return n}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let r=this._positionCount.get(t)??0;r===1?this._positionCount.delete(t):this._positionCount.set(t,r-1)}_pruneComments(){let t=[],r={},n=o=>{o in this._comments&&(r[o]=this._comments[o])};for(;this._history.length>0;)t.push(this._undoMove());for(n(this.fen());;){let o=t.pop();if(!o)break;this._makeMove(o),n(this.fen())}this._comments=r}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let r=this._comments[t];return delete this._comments[t],{fen:t,comment:r}})}setCastlingRights(t,r){for(let o of[N,ue])r[o]!==void 0&&(r[o]?this._castling[t]|=ze[o]:this._castling[t]&=~ze[o]);this._updateCastlingRights();let n=this.getCastlingRights(t);return(r[N]===void 0||r[N]===n[N])&&(r[ue]===void 0||r[ue]===n[ue])}getCastlingRights(t){return{[N]:(this._castling[t]&ze[N])!==0,[ue]:(this._castling[t]&ze[ue])!==0}}moveNumber(){return this._moveNumber}};var Pr=["white","black"];var _e=["a","b","c","d","e","f","g","h"],Me=["1","2","3","4","5","6","7","8"];var Sr=[...Me].reverse(),Je=_e.flatMap(e=>Me.map(t=>e+t)),$=e=>Je[8*e[0]+e[1]],E=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];var et=Je.map(E);function Er(e){let t,r=()=>(t===void 0&&(t=e()),t);return r.clear=()=>{t=void 0},r}var Ar=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},$e=e=>e==="white"?"black":"white",he=(e,t)=>(e[0]-t[0])**2+(e[1]-t[1])**2,we=(e,t)=>e.role===t.role&&e.color===t.color,Mr=(e,t)=>e[0]===t[0]&&e[1]===t[1],pe=e=>(t,r)=>[(r?t[0]:7-t[0])*e.width/8,(r?7-t[1]:t[1])*e.height/8],G=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Et=(e,t,r=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${r})`},Ke=(e,t)=>{e.style.visibility=t?"visible":"hidden"},oe=e=>{if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(e.targetTouches?.[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},tt=e=>e.button===2,Z=(e,t)=>{let r=document.createElement(e);return t&&(r.className=t),r};function rt(e,t,r){let n=E(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[r.left+r.width*n[0]/8+r.width/16,r.top+r.height*(7-n[1])/8+r.height/16]}var X=(e,t)=>Math.abs(e-t),Ie=(e,t,r,n)=>X(e,r)*X(t,n)===2,nt=(e,t,r,n)=>e===r!=(t===n),ot=(e,t,r,n)=>X(e,r)===X(t,n)&&e!==r,it=(e,t,r,n)=>nt(e,t,r,n)||ot(e,t,r,n),At=(e,t,r,n)=>Math.max(X(e,r),X(t,n))===1,Mt=(e,t,r,n,o)=>X(e,r)===1&&n===t+(o?1:-1),$t=(e,t,r,n,o)=>{let i=o?1:-1;return e===r&&(n===t+i||n===t+2*i&&(o?t<=1:t>=6))},Re=(e,t,r,n)=>{let o=r-e,i=n-t;if(o&&i&&Math.abs(o)!==Math.abs(i))return[];let s=Math.sign(o),a=Math.sign(i),f=[],l=e+s,u=t+a;for(;l!==r||u!==n;)f.push([l,u]),l+=s,u+=a;return f.map(m=>$(m))},$r=e=>{let t=E(e),r=[];return t[0]>0&&r.push([t[0]-1,t[1]]),t[0]<7&&r.push([t[0]+1,t[1]]),r.map($)},Le=(e,t)=>{let r=E(e);return r[1]+=t,$(r)};var Te=e=>e.friendlies.has($(e.pos2)),ri=e=>e.enemies.has($(e.pos2)),Tr=(e,t,r)=>Re(...e,...t).some(n=>r.has(n)),xr=(e,t,r)=>{let n=r.enemies.get(e);if(n?.role!=="pawn")return!1;let o=n.color==="white"?1:-1,i=E(e),s=E(t);return $t(...i,...s,n.color==="white")&&!Tr(i,[s[0],s[1]+o],r.allPieces)},ni=(e,t,r)=>{let n=r.enemies.get(e);return n?.role==="pawn"&&Mt(...E(e),...E(t),n.color==="white")&&(r.friendlies.has(t)||at(Le(t,n.color==="white"?-1:1),r.friendlies,r.enemies,r.lastMove))},oi=e=>[...e.enemies.keys()].some(t=>xr(t,$(e.pos2),e)),Tt=(e,t)=>{let r=e.pos2;return[...e.enemies].some(([n,o])=>{let i=E(n);return!t?.includes(o.role)&&(o.role==="pawn"&&Mt(...i,...r,o.color==="white")||o.role==="knight"&&Ie(...i,...r)||o.role==="bishop"&&ot(...i,...r)||o.role==="rook"&&nt(...i,...r)||o.role==="queen"&&it(...i,...r)||o.role==="king"&&At(...i,...r))&&(!["bishop","rook","queen"].includes(o.role)||!Tr(i,r,e.allPieces))})},st=e=>Te(e)&&(at($(e.pos2),e.friendlies,e.enemies,e.lastMove)||Tt(e)),at=(e,t,r,n)=>{if(n&&e!==n[1])return!1;let o=E(e),i=t.get(e);return i?.role==="pawn"&&o[1]===(i.color==="white"?3:4)&&(!n||X(E(n[0])[1],o[1])===2)&&[1,-1].some(s=>r.get($([o[0]+s,o[1]]))?.role==="pawn")},ii=e=>{if(e.unrestrictedPremoves)return!0;let t=Re(...e.pos1,...e.pos2),r=t.filter(n=>e.friendlies.has(n));return!r.length||r.length===1&&at(r[0],e.friendlies,e.enemies,e.lastMove)&&!t.includes(Le(r[0],e.color==="white"?-1:1))},si=e=>{if(e.unrestrictedPremoves)return!0;let t=Re(...e.pos1,...e.pos2),r=t.filter(l=>e.enemies.has(l));if(r.length>1)return!1;if(!r.length)return!0;let n=r[0],o=e.enemies.get(n);if(!o||o.role!=="pawn")return!0;let i=o.color==="white"?1:-1,s=Le(n,i),a=[...$r(s).filter(l=>ni(n,l,e)),...[s,Le(s,i)].filter(l=>xr(n,l,e))],f=[...t,$(e.pos1)];return a.some(l=>!f.includes(l))},xt=e=>ii(e)&&si(e),ai=e=>{let t=e.color==="white"?1:-1;return X(e.pos1[0],e.pos2[0])>1?!1:X(e.pos1[0],e.pos2[0])?e.pos2[1]!==e.pos1[1]+t?!1:e.unrestrictedPremoves||ri(e)?!0:Te(e)?Tt(e):oi(e)||at($([e.pos2[0],e.pos2[1]+t]),e.friendlies,e.enemies,e.lastMove)||Tt(e,["pawn"]):$t(...e.pos1,...e.pos2,e.color==="white")&&xt({...e,pos2:[e.pos2[0],e.pos2[1]+t]})},li=e=>Ie(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!Te(e)||st(e)),qr=e=>ot(...e.pos1,...e.pos2)&&xt(e)&&(e.unrestrictedPremoves||!Te(e)||st(e)),Nr=e=>nt(...e.pos1,...e.pos2)&&xt(e)&&(e.unrestrictedPremoves||!Te(e)||st(e)),ci=e=>qr(e)||Nr(e),fi=e=>At(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!Te(e)||st(e))||e.canCastle&&e.pos1[1]===e.pos2[1]&&e.pos1[1]===(e.color==="white"?0:7)&&(e.pos1[0]===4&&(e.pos2[0]===2&&e.rookFilesFriendlies.includes(0)||e.pos2[0]===6&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.pos2[0]))&&(e.unrestrictedPremoves||Re(...e.pos1,e.pos2[0]>e.pos1[0]?7:1,e.pos2[1]).map(t=>e.allPieces.get(t)).every(t=>!t||we(t,{role:"rook",color:e.color}))),ui={pawn:ai,knight:li,bishop:qr,rook:Nr,queen:ci,king:fi};function qt(e,t){let r=e.pieces,n=e.premovable.castle,o=!!e.premovable.unrestrictedPremoves,i=r.get(t);if(!i||i.color===e.turnColor)return[];let s=i.color,a=new Map([...r].filter(([g,b])=>b.color===s)),f=new Map([...r].filter(([g,b])=>b.color===$e(s))),l=E(t),u=ui[i.role],m={pos1:l,allPieces:r,friendlies:a,enemies:f,unrestrictedPremoves:o,color:s,canCastle:n,rookFilesFriendlies:Array.from(r).filter(([g,b])=>g[1]===(s==="white"?"1":"8")&&b.color===s&&b.role==="rook").map(([g])=>E(g)[0]),lastMove:e.lastMove};return et.filter(g=>u({...m,pos2:g})).map($)}function W(e,...t){e&&setTimeout(()=>e(...t),1)}function Dr(e){e.orientation=$e(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Or(e,t){for(let[r,n]of t)n?e.pieces.set(r,n):e.pieces.delete(r)}function Kr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[r,n]of e.pieces)n.role==="king"&&n.color===t&&(e.check=r)}function hi(e,t,r,n){ee(e),e.premovable.current=[t,r],W(e.premovable.events.set,t,r,n)}function J(e){e.premovable.current&&(e.premovable.current=void 0,W(e.premovable.events.unset))}function pi(e,t,r){J(e),e.predroppable.current={role:t,key:r},W(e.predroppable.events.set,t,r)}function ee(e){let t=e.predroppable;t.current&&(t.current=void 0,W(t.events.unset))}function di(e,t,r){if(!e.autoCastle)return!1;let n=e.pieces.get(t);if(!n||n.role!=="king")return!1;let o=E(t),i=E(r);if(o[1]!==0&&o[1]!==7||o[1]!==i[1])return!1;o[0]===4&&!e.pieces.has(r)&&(i[0]===6?r=$([7,i[1]]):i[0]===2&&(r=$([0,i[1]])));let s=e.pieces.get(r);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(r),o[0]<i[0]?(e.pieces.set($([6,i[1]]),n),e.pieces.set($([5,i[1]]),s)):(e.pieces.set($([2,i[1]]),n),e.pieces.set($([3,i[1]]),s)),!0)}function Nt(e,t,r){let n=e.pieces.get(t),o=e.pieces.get(r);if(t===r||!n)return!1;let i=o&&o.color!==n.color?o:void 0;return r===e.selected&&H(e),W(e.events.move,t,r,i),di(e,t,r)||(e.pieces.set(r,n),e.pieces.delete(t)),e.lastMove=[t,r],e.check=void 0,W(e.events.change),i||!0}function lt(e,t,r,n){if(e.pieces.has(r))if(n)e.pieces.delete(r);else return!1;return W(e.events.dropNewPiece,t,r),e.pieces.set(r,t),e.lastMove=[r],e.check=void 0,W(e.events.change),e.movable.dests=void 0,e.turnColor=$e(e.turnColor),!0}function Ir(e,t,r){let n=Nt(e,t,r);return n&&(e.movable.dests=void 0,e.turnColor=$e(e.turnColor),e.animation.current=void 0),n}function Dt(e,t,r){if(ft(e,t,r)){let n=Ir(e,t,r);if(n){let o=e.hold.stop();H(e);let i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return n!==!0&&(i.captured=n),W(e.movable.events.after,t,r,i),!0}}else if(mi(e,t,r))return hi(e,t,r,{ctrlKey:e.stats.ctrlKey}),H(e),!0;return H(e),!1}function ct(e,t,r,n){let o=e.pieces.get(t);o&&(gi(e,t,r)||n)?(e.pieces.delete(t),lt(e,o,r,n),W(e.movable.events.afterNewPiece,o.role,r,{premove:!1,predrop:!1})):o&&bi(e,t,r)?pi(e,o.role,r):(J(e),ee(e)),e.pieces.delete(t),H(e)}function Be(e,t,r){if(W(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){H(e),e.hold.cancel();return}else if((e.selectable.enabled||r)&&e.selected!==t&&Dt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Rr(e,t)||Kt(e,t))&&(Ot(e,t),e.hold.start())}function Ot(e,t){e.selected=t,Kt(e,t)?e.premovable.customDests||(e.premovable.dests=qt(e,t)):e.premovable.dests=void 0}function H(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Rr(e,t){let r=e.pieces.get(t);return!!r&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}var ft=(e,t,r)=>t!==r&&Rr(e,t)&&(e.movable.free||!!e.movable.dests?.get(t)?.includes(r));function gi(e,t,r){let n=e.pieces.get(t);return!!n&&(t===r||!e.pieces.has(r))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function Kt(e,t){let r=e.pieces.get(t);return!!r&&e.premovable.enabled&&e.movable.color===r.color&&e.turnColor!==r.color}var mi=(e,t,r)=>t!==r&&Kt(e,t)&&(e.premovable.customDests?.get(t)??qt(e,t)).includes(r);function bi(e,t,r){let n=e.pieces.get(t),o=e.pieces.get(r);return!!n&&(!o||o.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||r[1]!=="1"&&r[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function Lr(e,t){let r=e.pieces.get(t);return!!r&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===r.color&&(e.turnColor===r.color||e.premovable.enabled))}function Fr(e){let t=e.premovable.current;if(!t)return!1;let r=t[0],n=t[1],o=!1;if(ft(e,r,n)){let i=Ir(e,r,n);if(i){let s={premove:!0};i!==!0&&(s.captured=i),W(e.movable.events.after,r,n,s),o=!0}}return J(e),o}function Br(e,t){let r=e.predroppable.current,n=!1;if(!r)return!1;if(t(r)){let o={role:r.role,color:e.movable.color};lt(e,o,r.key)&&(W(e.movable.events.afterNewPiece,r.role,r.key,{premove:!1,predrop:!0}),n=!0)}return ee(e),n}function Ue(e){J(e),ee(e),H(e)}function It(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Ue(e)}function te(e,t,r){let n=Math.floor(8*(e[0]-r.left)/r.width);t||(n=7-n);let o=7-Math.floor(8*(e[1]-r.top)/r.height);return t||(o=7-o),n>=0&&n<8&&o>=0&&o<8?$([n,o]):void 0}function Ur(e,t,r,n){let o=E(e),i=et.filter(l=>Mr(o,l)||it(o[0],o[1],l[0],l[1])||Ie(o[0],o[1],l[0],l[1])),a=i.map(l=>rt($(l),r,n)).map(l=>he(t,l)),[,f]=a.reduce((l,u,m)=>l[0]<u?l:[u,m],[a[0],0]);return $(i[f])}var x=e=>e.orientation==="white";var Lt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",vi={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},_i={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ut(e){e==="start"&&(e=Lt);let t=new Map,r=7,n=0;for(let o of e)switch(o){case" ":case"[":return t;case"/":if(--r,r<0)return t;n=0;break;case"~":{let i=t.get($([n-1,r]));i&&(i.promoted=!0);break}default:{let i=o.charCodeAt(0);if(i<57)n+=i-48;else{let s=o.toLowerCase();t.set($([n,r]),{role:vi[s],color:o===s?"black":"white"}),++n}}}return t}function Hr(e){return Sr.map(t=>_e.map(r=>{let n=e.get(r+t);if(n){let o=_i[n.role];return n.color==="white"&&(o=o.toUpperCase()),n.promoted&&(o+="~"),o}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Ft(e,t){t.animation&&(Bt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ht(e,t){if(t.movable?.dests&&(e.movable.dests=void 0),t.drawable?.autoShapes&&(e.drawable.autoShapes=[]),Bt(e,t),t.fen&&(e.pieces=ut(t.fen),e.drawable.shapes=t.drawable?.shapes||[]),"check"in t&&Kr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Ot(e,e.selected),Ft(e,t),!e.movable.rookCastle&&e.movable.dests){let r=e.movable.color==="white"?"1":"8",n="e"+r,o=e.movable.dests.get(n),i=e.pieces.get(n);if(!o||!i||i.role!=="king")return;e.movable.dests.set(n,o.filter(s=>!(s==="a"+r&&o.includes("c"+r))&&!(s==="h"+r&&o.includes("g"+r))))}}function Bt(e,t){for(let r in t)r==="__proto__"||r==="constructor"||!Object.prototype.hasOwnProperty.call(t,r)||(Object.prototype.hasOwnProperty.call(e,r)&&Wr(e[r])&&Wr(t[r])?Bt(e[r],t[r]):e[r]=t[r])}function Wr(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var ie=(e,t)=>t.animation.enabled?Pi(e,t):se(e,t);function se(e,t){let r=e(t);return t.dom.redraw(),r}var Ut=(e,t)=>({key:e,pos:E(e),piece:t}),yi=(e,t)=>t.sort((r,n)=>he(e.pos,r.pos)-he(e.pos,n.pos))[0];function ki(e,t){let r=new Map,n=[],o=new Map,i=[],s=[],a=new Map,f,l,u;for(let[m,g]of e)a.set(m,Ut(m,g));for(let m of Je)f=t.pieces.get(m),l=a.get(m),f?l?we(f,l.piece)||(i.push(l),s.push(Ut(m,f))):s.push(Ut(m,f)):l&&i.push(l);for(let m of s)l=yi(m,i.filter(g=>we(m.piece,g.piece))),l&&(u=[l.pos[0]-m.pos[0],l.pos[1]-m.pos[1]],r.set(m.key,u.concat(u)),n.push(l.key));for(let m of i)n.includes(m.key)||o.set(m.key,m.piece);return{anims:r,fadings:o}}function jr(e,t){let r=e.animation.current;if(r===void 0){e.dom.destroyed||e.dom.redrawNow();return}let n=1-(t-r.start)*r.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{let o=Ci(n);for(let i of r.plan.anims.values())i[2]=i[0]*o,i[3]=i[1]*o;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>jr(e,i))}}function Pi(e,t){let r=new Map(t.pieces),n=e(t),o=ki(r,t);if(o.anims.size||o.fadings.size){let i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},i||jr(t,performance.now())}else t.dom.redraw();return n}var Ci=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var Si=["green","red","blue","yellow"];function Qr(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?H(e):Ue(e);let r=oe(t),n=te(r,x(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:r,brush:Ei(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Vr(e))}function Vr(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let r=te(t.pos,x(e),e.dom.bounds());r||(t.snapToValidMove=!1);let n=t.snapToValidMove?Ur(t.orig,t.pos,x(e),e.dom.bounds()):r;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),Vr(e)}})}function zr(e,t){e.drawable.current&&(e.drawable.current.pos=oe(t))}function Gr(e){let t=e.drawable.current;t&&(t.mouseSq&&Ai(e.drawable,t),Ht(e))}function Ht(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Zr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Yr(e.drawable))}function Ei(e){let t=(e.shiftKey||e.ctrlKey)&&tt(e),r=e.altKey||e.metaKey||e.getModifierState?.("AltGraph");return Si[(t?1:0)+(r?2:0)]}function Ai(e,t){let r=o=>o.orig===t.orig&&o.dest===t.dest,n=e.shapes.find(r);n&&(e.shapes=e.shapes.filter(o=>!r(o))),(!n||n.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Yr(e)}function Yr(e){e.onChange&&e.onChange(e.shapes)}function Xr(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let r=e.dom.bounds(),n=oe(t),o=te(n,x(e),r);if(!o)return;let i=e.pieces.get(o),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&Zr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||s||$i(e,n)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,f=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&ft(e,e.selected,o)?ie(m=>Be(m,o),e):Be(e,o);let l=e.selected===o,u=nn(e,o);if(i&&u&&l&&Lr(e,o)){e.draggable.current={orig:o,piece:i,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");let m=e.dom.elements.ghost;m&&(m.className=`ghost ${i.color} ${i.role}`,G(m,pe(r)(E(o),x(e))),Ke(m,!0)),Wt(e)}else a&&J(e),f&&ee(e);e.dom.redraw()}function $i(e,t){let r=x(e),n=e.dom.bounds(),o=Math.pow(e.touchIgnoreRadius*n.width/16,2)*2;for(let i of e.pieces.keys()){let s=rt(i,r,n);if(he(s,t)<=o)return!0}return!1}function Jr(e,t,r,n){e.pieces.set("a0",t),e.dom.redraw();let i=oe(r);e.draggable.current={orig:"a0",piece:t,origPos:i,pos:i,started:!0,element:()=>nn(e,"a0"),originTarget:r.target,newPiece:!0,force:!!n,keyHasChanged:!1},Wt(e)}function Wt(e){requestAnimationFrame(()=>{let t=e.draggable.current;if(!t)return;e.animation.current?.plan.anims.has(t.orig)&&(e.animation.current=void 0);let r=e.pieces.get(t.orig);if(!r||!we(r,t.piece))ye(e);else if(!t.started&&he(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if(typeof t.element=="function"){let o=t.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),t.element=o}let n=e.dom.bounds();G(t.element,[t.pos[0]-n.left-n.width/16,t.pos[1]-n.top-n.height/16]),t.keyHasChanged||(t.keyHasChanged=t.orig!==te(t.pos,x(e),n))}Wt(e)})}function en(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=oe(t))}function tn(e,t){let r=e.draggable.current;if(!r)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&r.originTarget!==t.target&&!r.newPiece){e.draggable.current=void 0;return}J(e),ee(e);let n=oe(t)||r.pos,o=te(n,x(e),e.dom.bounds());o&&r.started&&r.orig!==o?r.newPiece?ct(e,r.orig,o,r.force):(e.stats.ctrlKey=t.ctrlKey,Dt(e,r.orig,o)&&(e.stats.dragged=!0)):r.newPiece?e.pieces.delete(r.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(r.orig),W(e.events.change)),(r.orig===r.previouslySelected||r.keyHasChanged)&&(r.orig===o||!o)?H(e):e.selectable.enabled||H(e),rn(e),e.draggable.current=void 0,e.dom.redraw()}function ye(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,H(e),rn(e),e.dom.redraw())}function rn(e){let t=e.dom.elements;t.ghost&&Ke(t.ghost,!1)}function nn(e,t){let r=e.dom.elements.board.firstChild;for(;r;){if(r.cgKey===t&&r.tagName==="PIECE")return r;r=r.nextSibling}}function sn(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{on(e,2),setTimeout(()=>on(e,void 0),120)},120)}function on(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function an(e,t){function r(){Dr(e),t()}return{set(n){n.orientation&&n.orientation!==e.orientation&&r(),Ft(e,n),(n.fen?ie:se)(o=>ht(o,n),e)},state:e,getFen:()=>Hr(e.pieces),toggleOrientation:r,setPieces(n){ie(o=>Or(o,n),e)},selectSquare(n,o){n?ie(i=>Be(i,n,o),e):e.selected&&(H(e),e.dom.redraw())},move(n,o){ie(i=>Nt(i,n,o),e)},newPiece(n,o){ie(i=>lt(i,n,o),e)},playPremove(){if(e.premovable.current){if(ie(Fr,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){let o=Br(e,n);return e.dom.redraw(),o}return!1},cancelPremove(){se(J,e)},cancelPredrop(){se(ee,e)},cancelMove(){se(n=>{Ue(n),ye(n)},e)},stop(){se(n=>{It(n),ye(n)},e)},explode(n){sn(e,n)},setAutoShapes(n){se(o=>o.drawable.autoShapes=n,e)},setShapes(n){se(o=>o.drawable.shapes=n.slice(),e)},getKeyAtDomPos(n){return te(n,x(e),e.dom.bounds())},redrawAll:t,dragNewPiece(n,o,i){Jr(e,n,o,i)},destroy(){It(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function ln(){return{pieces:ut(Lt),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,touchIgnoreRadius:1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:Ar()}}function un(){let e=K("defs"),t=L(K("filter"),{id:"cg-filter-blur"});return t.appendChild(L(K("feGaussianBlur"),{stdDeviation:"0.013"})),e.appendChild(t),e}function hn(e,t){let r=e.drawable,n=r.current,o=n&&n.mouseSq?n:void 0,i=new Map,s=e.dom.bounds(),a=r.autoShapes.filter(u=>!u.piece);for(let u of r.shapes.concat(a).concat(o?[o]:[])){if(!u.dest)continue;let m=i.get(u.dest)??new Set,g=dt(pt(E(u.orig),e.orientation),s),b=dt(pt(E(u.dest),e.orientation),s);m.add(Qt(g,b)),i.set(u.dest,m)}let f=[];for(let u of r.shapes.concat(a))f.push({shape:u,current:!1,hash:cn(u,jt(u.dest,i),!1,s)});o&&f.push({shape:o,current:!0,hash:cn(o,jt(o.dest,i),!0,s)});let l=f.map(u=>u.hash).join(";");l!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=l,xi(r,f,t),qi(f,t,u=>Oi(e,u,r.brushes,i,s)))}function xi(e,t,r){for(let n of[r.shapes,r.shapesBelow]){let o=n.querySelector("defs"),i=t.filter(l=>n===r.shapesBelow==!!l.shape.below),s=new Map;for(let l of i.filter(u=>u.shape.dest&&u.shape.brush)){let u=pn(e.brushes[l.shape.brush],l.shape.modifiers),{key:m,color:g}=dn(l.shape);m&&g&&s.set(m,{key:m,color:g,opacity:1,lineWidth:1}),s.set(u.key,u)}let a=new Set,f=o.firstElementChild;for(;f;)a.add(f.getAttribute("cgKey")),f=f.nextElementSibling;for(let[l,u]of s.entries())a.has(l)||o.appendChild(Ri(u))}}function qi(e,t,r){for(let[n,o]of[[t.shapes,t.custom],[t.shapesBelow,t.customBelow]]){let[i,s]=[n,o].map(l=>l.querySelector("g")),a=e.filter(l=>n===t.shapesBelow==!!l.shape.below),f=new Map;for(let l of a)f.set(l.hash,!1);for(let l of[i,s]){let u=[],m=l.firstElementChild,g;for(;m;)g=m.getAttribute("cgHash"),f.has(g)?f.set(g,!0):u.push(m),m=m.nextElementSibling;for(let b of u)l.removeChild(b)}for(let l of a.filter(u=>!f.get(u.hash)))for(let u of r(l))u.isCustom?s.appendChild(u.el):i.appendChild(u.el)}}function cn({orig:e,dest:t,brush:r,piece:n,modifiers:o,customSvg:i,label:s,below:a},f,l,u){return[u.width,u.height,l,e,t,r,f&&"-",n&&Ni(n),o&&Di(o),i&&`custom-${fn(i.html)},${i.center?.[0]??"o"}`,s&&`label-${fn(s.text)}`,a&&"below"].filter(m=>m).join(",")}function Ni(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Di(e){return[e.lineWidth,e.hilite].filter(t=>t).join(",")}function fn(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r)>>>0;return t.toString()}function Oi(e,{shape:t,current:r,hash:n},o,i,s){let a=dt(pt(E(t.orig),e.orientation),s),f=t.dest?dt(pt(E(t.dest),e.orientation),s):a,l=t.brush&&pn(o[t.brush],t.modifiers),u=i.get(t.dest),m=[];if(l){let g=L(K("g"),{cgHash:n});m.push({el:g}),a[0]!==f[0]||a[1]!==f[1]?g.appendChild(Ii(t,l,a,f,r,jt(t.dest,i))):g.appendChild(Ki(o[t.brush],a,r,s))}if(t.label){let g=t.label;g.fill??(g.fill=t.brush&&o[t.brush].color);let b=t.brush?void 0:"tr";m.push({el:Li(g,n,a,f,u,b),isCustom:!0})}if(t.customSvg){let g=t.customSvg.center??"orig",[b,P]=g==="label"?mn(a,f,u).map(q=>q-.5):g==="dest"?f:a,_=L(K("g"),{transform:`translate(${b},${P})`,cgHash:n});_.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,m.push({el:_,isCustom:!0})}return m}function Ki(e,t,r,n){let o=Fi(),i=(n.width+n.height)/(4*Math.max(n.width,n.height));return L(K("circle"),{stroke:e.color,"stroke-width":o[r?0:1],fill:"none",opacity:gn(e,r),cx:t[0],cy:t[1],r:i-o[1]/2})}function Ii(e,t,r,n,o,i){function s(l){let u=Ui(i&&!o),m=n[0]-r[0],g=n[1]-r[1],b=Math.atan2(g,m),P=Math.cos(b)*u,_=Math.sin(b)*u,q=dn(e);return L(K("line"),{stroke:l?q.color:t.color,"stroke-width":Bi(t,o)*(l?1.14:1),"stroke-linecap":"round","marker-end":`url(#arrowhead-${l?q.key:t.key})`,opacity:e.modifiers?.hilite?1:gn(t,o),x1:r[0],y1:r[1],x2:n[0]-P,y2:n[1]-_})}if(!e.modifiers?.hilite)return s(!1);let a=L(K("g"),{opacity:t.opacity}),f=L(K("g"),{filter:"url(#cg-filter-blur)"});return f.appendChild(Hi(r,n)),f.appendChild(s(!0)),a.appendChild(f),a.appendChild(s(!1)),a}function Ri(e){let t=L(K("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(L(K("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Li(e,t,r,n,o,i){let a=.4*.75**e.text.length,f=mn(r,n,o),l=i==="tr"?.4:0,u=L(K("g"),{transform:`translate(${f[0]+l},${f[1]-l})`,cgHash:t});u.appendChild(L(K("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:e.fill??"#666",stroke:"white"}));let m=L(K("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return m.innerHTML=e.text,u.appendChild(m),u}function pt(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function jt(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function K(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function L(e,t){for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.setAttribute(r,t[r]);return e}function pn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(r=>r).join("")}:e}function Fi(){return[3/64,4/64]}function Bi(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function dn(e){let t=e.modifiers?.hilite;return{key:t&&`hilite-${t.replace("#","")}`,color:t}}function gn(e,t){return(e.opacity||1)*(t?.9:1)}function Ui(e){return(e?20:10)/64}function dt(e,t){let r=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*r,(3.5-e[1])*n]}function Hi(e,t){let r={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return L(K("rect"),{x:r.from[0],y:r.from[1],width:r.to[0]-r.from[0],height:r.to[1]-r.from[1],fill:"none",stroke:"none"})}function Qt(e,t,r=!0){let n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return r?(Math.round(n*8/Math.PI)+16)%16:n}function Wi(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((r,n)=>r+n*n,0))}function mn(e,t,r){let n=Wi(e,t),o=Qt(e,t,!1);if(r&&(n-=33/64,r.size>1)){n-=10/64;let i=Qt(e,t);(r.has((i+1)%16)||r.has((i+15)%16))&&i&1&&(n-=.4)}return[e[0]-Math.cos(o)*n,e[1]-Math.sin(o)*n].map(i=>i+.5)}function vn(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let u of Pr)e.classList.toggle("orientation-"+u,t.orientation===u);e.classList.toggle("manipulable",!t.viewOnly);let r=Z("cg-container");e.appendChild(r);let n=Z("cg-board");r.appendChild(n);let o,i,s,a,f;if(t.drawable.visible&&([o,i]=["cg-shapes-below","cg-shapes"].map(u=>bn(u,!0)),[s,a]=["cg-custom-below","cg-custom-svgs"].map(u=>bn(u,!1)),f=Z("cg-auto-pieces"),r.appendChild(o),r.appendChild(s),r.appendChild(i),r.appendChild(a),r.appendChild(f)),t.coordinates){let u=t.orientation==="black"?" black":"",m=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){let g=t.orientation==="white"?b=>b+1:b=>8-b;_e.forEach((b,P)=>r.appendChild(Vt(Me.map(_=>b+_),"squares rank"+g(P)+u+m)))}else r.appendChild(Vt(Me,"ranks"+u+m)),r.appendChild(Vt(_e,"files"+u))}let l;return t.draggable.enabled&&t.draggable.showGhost&&(l=Z("piece","ghost"),Ke(l,!1),r.appendChild(l)),{board:n,container:r,wrap:e,ghost:l,shapes:i,shapesBelow:o,custom:a,customBelow:s,autoPieces:f}}function bn(e,t){let r=L(K("svg"),{class:e,viewBox:t?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return r.appendChild(K("g")),t&&r.appendChild(un()),r}function Vt(e,t){let r=Z("coords",t),n;for(let o of e)n=Z("coord"),n.textContent=o,r.appendChild(n);return r}function _n(e,t){if(!e.dropmode.active)return;J(e),ee(e);let r=e.dropmode.piece;if(r){e.pieces.set("a0",r);let n=oe(t),o=n&&te(n,x(e),e.dom.bounds());o&&ct(e,"a0",o)}e.dom.redraw()}function yn(e,t){let r=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&r.addEventListener("contextmenu",o=>o.preventDefault()),e.viewOnly)return;let n=Qi(e);r.addEventListener("touchstart",n,{passive:!1}),r.addEventListener("mousedown",n,{passive:!1})}function kn(e,t){let r=[];if("ResizeObserver"in window||r.push(He(document.body,"chessground.resize",t)),!e.viewOnly){let n=wn(e,en,zr),o=wn(e,tn,Gr);for(let s of["touchmove","mousemove"])r.push(He(document,s,n));for(let s of["touchend","mouseup"])r.push(He(document,s,o));let i=()=>e.dom.bounds.clear();r.push(He(document,"scroll",i,{capture:!0,passive:!0})),r.push(He(window,"resize",i,{passive:!0}))}return()=>r.forEach(n=>n())}function He(e,t,r,n){return e.addEventListener(t,r,n),()=>e.removeEventListener(t,r,n)}var Qi=e=>t=>{e.draggable.current?ye(e):e.drawable.current?Ht(e):t.shiftKey||tt(t)?e.drawable.enabled&&Qr(e,t):e.viewOnly||(e.dropmode.active?_n(e,t):Xr(e,t))},wn=(e,t,r)=>n=>{e.drawable.current?e.drawable.enabled&&r(e,n):e.viewOnly||t(e,n)};function Cn(e){let t=x(e),r=pe(e.dom.bounds()),n=e.dom.elements.board,o=e.pieces,i=e.animation.current,s=i?i.plan.anims:new Map,a=i?i.plan.fadings:new Map,f=e.draggable.current,l=zi(e),u=new Set,m=new Set,g=new Map,b=new Map,P,_,q,re,F,de,ke,j,Pe,Ce;for(_=n.firstChild;_;){if(P=_.cgKey,En(_))if(q=o.get(P),F=s.get(P),de=a.get(P),re=_.cgPiece,_.cgDragging&&(!f||f.orig!==P)&&(_.classList.remove("dragging"),G(_,r(E(P),t)),_.cgDragging=!1),!de&&_.cgFading&&(_.cgFading=!1,_.classList.remove("fading")),q){if(F&&_.cgAnimating&&re===We(q)){let M=E(P);M[0]+=F[2],M[1]+=F[3],_.classList.add("anim"),G(_,r(M,t))}else _.cgAnimating&&(_.cgAnimating=!1,_.classList.remove("anim"),G(_,r(E(P),t)),e.addPieceZIndex&&(_.style.zIndex=zt(E(P),t)));re===We(q)&&(!de||!_.cgFading)?u.add(P):de&&re===We(de)?(_.classList.add("fading"),_.cgFading=!0):Gt(g,re,_)}else Gt(g,re,_);else if(An(_)){let M=_.className;l.get(P)===M?m.add(P):Gt(b,M,_)}_=_.nextSibling}for(let[M,le]of l)if(!m.has(M)){Pe=b.get(le),Ce=Pe&&Pe.pop();let B=r(E(M),t);if(Ce)Ce.cgKey=M,G(Ce,B);else{let Q=Z("square",le);Q.cgKey=M,G(Q,B),n.insertBefore(Q,n.firstChild)}}for(let[M,le]of o)if(F=s.get(M),!u.has(M))if(ke=g.get(We(le)),j=ke&&ke.pop(),j){j.cgKey=M,j.cgFading&&(j.classList.remove("fading"),j.cgFading=!1);let B=E(M);e.addPieceZIndex&&(j.style.zIndex=zt(B,t)),F&&(j.cgAnimating=!0,j.classList.add("anim"),B[0]+=F[2],B[1]+=F[3]),G(j,r(B,t))}else{let B=We(le),Q=Z("piece",B),ge=E(M);Q.cgPiece=B,Q.cgKey=M,F&&(Q.cgAnimating=!0,ge[0]+=F[2],ge[1]+=F[3]),G(Q,r(ge,t)),e.addPieceZIndex&&(Q.style.zIndex=zt(ge,t)),n.appendChild(Q)}for(let M of g.values())Pn(e,M);for(let M of b.values())Pn(e,M)}function Sn(e){let t=x(e),r=pe(e.dom.bounds()),n=e.dom.elements.board.firstChild;for(;n;)(En(n)&&!n.cgAnimating||An(n))&&G(n,r(E(n.cgKey),t)),n=n.nextSibling}function Zt(e){let t=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,n=t.height/t.width,o=Math.floor(t.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,i=o*n;r.style.width=o+"px",r.style.height=i+"px",e.dom.bounds.clear(),e.addDimensionsCssVarsTo?.style.setProperty("---cg-width",o+"px"),e.addDimensionsCssVarsTo?.style.setProperty("---cg-height",i+"px")}var En=e=>e.tagName==="PIECE",An=e=>e.tagName==="SQUARE";function Pn(e,t){for(let r of t)e.dom.elements.board.removeChild(r)}function zt(e,t){let n=e[1];return`${t?10-n:3+n}`}var We=e=>`${e.color} ${e.role}`;function zi(e){let t=new Map;if(e.lastMove&&e.highlight.lastMove)for(let o of e.lastMove)ae(t,o,"last-move");if(e.check&&e.highlight.check&&ae(t,e.check,"check"),e.selected&&(ae(t,e.selected,"selected"),e.movable.showDests)){let o=e.movable.dests?.get(e.selected);if(o)for(let s of o)ae(t,s,"move-dest"+(e.pieces.has(s)?" oc":""));let i=e.premovable.customDests?.get(e.selected)??e.premovable.dests;if(i)for(let s of i)ae(t,s,"premove-dest"+(e.pieces.has(s)?" oc":""))}let r=e.premovable.current;if(r)for(let o of r)ae(t,o,"current-premove");else e.predroppable.current&&ae(t,e.predroppable.current.key,"current-premove");let n=e.exploding;if(n)for(let o of n.keys)ae(t,o,"exploding"+n.stage);return e.highlight.custom&&e.highlight.custom.forEach((o,i)=>{ae(t,i,o)}),t}function ae(e,t,r){let n=e.get(t);n?e.set(t,`${n} ${r}`):e.set(t,r)}function Gt(e,t,r){let n=e.get(t);n?n.push(r):e.set(t,[r])}function Mn(e,t,r){let n=new Map,o=[];for(let a of e)n.set(a.hash,!1);let i=t.firstElementChild,s;for(;i;)s=i.getAttribute("cgHash"),n.has(s)?n.set(s,!0):o.push(i),i=i.nextElementSibling;for(let a of o)t.removeChild(a);for(let a of e)n.get(a.hash)||t.appendChild(r(a))}function $n(e,t){let n=e.drawable.autoShapes.filter(o=>o.piece).map(o=>({shape:o,hash:Zi(o),current:!1}));Mn(n,t,o=>Gi(e,o,e.dom.bounds()))}function Tn(e){let t=x(e),r=pe(e.dom.bounds()),n=e.dom.elements.autoPieces?.firstChild;for(;n;)Et(n,r(E(n.cgKey),t),n.cgScale),n=n.nextSibling}function Gi(e,{shape:t,hash:r},n){let o=t.orig,i=t.piece?.role,s=t.piece?.color,a=t.piece?.scale,f=Z("piece",`${i} ${s}`);return f.setAttribute("cgHash",r),f.cgKey=o,f.cgScale=a,Et(f,pe(n)(E(o),x(e)),a),f}var Zi=e=>[e.orig,e.piece?.role,e.piece?.color,e.piece?.scale].join(",");function xn(e,t){let r=ln();ht(r,t||{});function n(){let o="dom"in r?r.dom.unbind:void 0,i=vn(e,r),s=Er(()=>i.board.getBoundingClientRect()),a=u=>{Cn(l),i.autoPieces&&$n(l,i.autoPieces),!u&&i.shapes&&hn(l,i)},f=()=>{Zt(l),Sn(l),i.autoPieces&&Tn(l)},l=r;return l.dom={elements:i,bounds:s,redraw:Xi(a),redrawNow:a,unbind:o},l.drawable.prevSvgHash="",Zt(l),a(!1),yn(l,f),o||(l.dom.unbind=kn(l,f)),l.events.insert&&l.events.insert(i),l}return an(n(),n)}function Xi(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var xe=new Ye,Yt=xn(document.getElementById("board"),{dropOffBoard:"trash",sparePieces:!0,movable:{showDests:!0,draggable:!0,events:{after:(e,t)=>{try{xe.move({from:e,to:t,promotion:"q"}),Yt.set({fen:xe.fen()})}catch{Yt.set({fen:xe.fen()});return}xe.turn()==="b"&&fetch("http://0.0.0.0:8080").then(r=>r.text()).then(r=>{xe.move(r),Yt.set({fen:xe.fen()})}).catch(r=>console.log(r))}}}});})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
